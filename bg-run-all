#!/bin/bash

set -ue
source $CMB_HOME/env.sh
cd $TMP_DIR

option=${1:--s}

case $option in
  -s) ps -C run-all;;
  -k) pgid=$(ps -C run-all -o pgid= | tr -d ' ')
      [[ -n $pgid ]] && kill -TERM -$pgid && echo run-all killed
      for n in $(cat bench_nodes); do
        ssh root@$n "pid=\$(ps -C beam.smp -o pid= | tr -d ' ') && \
[[ -n \$pid ]] && kill -TERM \$pid && echo $n: basho_bench killed" &
      done; wait
      for n in $(cat srv_nodes); do
        ssh root@$n "pgid=\$(ps -C beam.smp -o pgid= | tr -d ' ') && \
[[ -n \$pgid ]] && kill -TERM \$pgid && echo $n: riak killed" &
        ssh root@$n "pid=\$(ps -C epmd -o pid= | tr -d ' ') && \
[[ -n \$pid ]] && kill -TERM \$pid && echo $n: epmd killed" &
      done; wait
esac 
