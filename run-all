#!/bin/bash

set -u
source $CMB_HOME/env.sh

srvs=16
clis=4

# rw_ratios
# 0:1 - 50% reads / 50% writes (writes = 100% reads)
# 1:1 - 66% reads / 33% writes (writes = 50% reads)
# 3:1 - 80% reads / 20% writes (writes = 25% reads)
# 9:1 - 91% reads / 9% writes (writes = 10% reads)
# 1:0 - 100% reads (writes = 0% reads)

modes=(ev any lat)
rs=(0:1 1:0 9:1 1:1 3:1)
ls=(0.5 0.9)
ps=(uni par)
ds=(0 50 100 150)

skip() {
#  ([[ $c == tl ]] && [[ $mode == any ]] && [[ $r == 1:1 ]] && [[ $l == 0.5 ]]) || \
#  && echo true || echo false
  echo false
}

est_time() {
  local et=-
  if [[ $exec -gt 0 ]]; then
    local t1=$(date +%s)
    ((et=rem * (t1 - t0) / exec))
    # doesn't work for diffs > a day 
    et=$(date --date "1970-01-01 $et sec" +%T)
  fi
  echo $et
}

((rem=${#modes[@]} * ${#rs[@]} * ${#ls[@]} * ${#ps[@]} * ${#ds[@]}))
echo =========================
echo "Number of tests: $rem"
echo =========================

exec=0
t0=$(date +%s)
for mode in "${modes[@]}"; do
  [[ $mode = ev ]] && c=ev || c=tl
  $CMB_HOME/srvs $srvs $clis $c
  $CMB_HOME/delay 0
  $CMB_HOME/start
  $CMB_HOME/load

  for r in "${rs[@]}"; do
    for l in "${ls[@]}"; do
      for p in "${ps[@]}"; do
        for d in "${ds[@]}"; do
          echo ===========================================
          echo "$c $mode $l $p $r $d ($rem / $(est_time))"
          echo ===========================================
          ((rem--))
          [[ $(skip) == true ]] && echo Skipping && continue
          sleep 15
          $CMB_HOME/delay $d
          $CMB_HOME/run $mode $l $p $r
          ((exec++))
        done
      done
    done
  done

  $CMB_HOME/delay 0
  $CMB_HOME/stop
done
